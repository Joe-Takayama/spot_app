{% extends "base/base.html" %}
{% load static %}

{% block title %}è¦³å…‰åœ°è©³ç´°{% endblock %}

{% block extra_css %}
<link href="{% static 'css/spot_detail.css' %}" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
{% endblock %}
{# ===== ãƒŠãƒ“ã‚’æœ€å°æ§‹æˆã«å·®ã—æ›¿ãˆ ===== #}
{% block nav %}
<nav class="profile-mini-nav">
<a href="{% url 'spotapp:index' %}" class="btn-home">ãƒ›ãƒ¼ãƒ </a>

  <div class="user-info">
    <div class="user-icon">
      {% if request.user.profile.icon %}
        <img src="{{ request.user.profile.icon.url }}" alt="icon">
      {% else %}
        <img src="{% static 'img/default_icon.png' %}" alt="icon">
      {% endif %}
    </div>
    <div class="user-name-text">
      {{ request.user.username }} ã•ã‚“
    </div>
  </div>
</nav>
{% endblock %}

{# ===== æ¤œç´¢ãƒãƒ¼ãƒ»ãƒ•ãƒƒã‚¿ãƒ¼ã¯æ¶ˆã™ ===== #}
{% block searchbar %}{% endblock %}
{% block footer %}{% endblock %}

{% block body %}
<div class="page">

    <!-- è¦³å…‰åœ°æƒ…å ± -->
    <div class="spot-info">
        <h1 class="spot-name">{{ spot.spot_name }}</h1>

        <div class="spot-image">
            {% if spot.spot_photos.all %}
                <div class="photo has-image">
                    <img
                        src="{{ spot.spot_photos.first.image.url }}"
                        alt="{{ spot.spot_name }}"
                        class="spot-img"
                    >
                </div>
            {% else %}
                <div class="photo no-image">
                    <img
                        src="{% static 'img/no-image.png' %}"
                        alt="no image"
                        class="spot-img"
                    >
                </div>
            {% endif %}
        </div>

        <div class="spot-actions" onclick="event.stopPropagation()">
            <button
                    id="fav-btn"
                    data-url="{% url 'spotapp:favorite_toggle_ajax' spot.spot_id %}"
                    class="fav-btn"
            >
                    {% if is_favorited %}
                        ç™»éŒ²æ¸ˆã¿
                    {% else %}
                        ãŠæ°—ã«å…¥ã‚Šç™»éŒ²
                    {% endif %}
            </button>
        </div>

        <h2 class="spot-address">ä½æ‰€<br>{{ spot.address }}</h2>
        <h2 class="spot-hours">å–¶æ¥­æ™‚é–“<br>{{ spot.business_hours }}</h2>

        <div class="spot-detail">
            <div class="spot-name">
                <h2>{{ spot.spot_name }}ã«ã¤ã„ã¦</h2>
            </div>
            <p>{{ spot.explanation }}</p>
        </div>

        <a href="{% url 'spotapp:review_detail' spot.spot_id %}"class="btn">
            ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦‹ã‚‹
        </a>

        <!-- ãƒ«ãƒ¼ãƒˆæ¡ˆå†…ãƒ»æ™‚é–“è¡¨ç¤º -->
        
        <div id="route-ui">
            <div class="route-input">
                <input id="start" type="text" placeholder="å‡ºç™ºåœ°ã‚’å…¥åŠ›ï¼ˆãƒ’ãƒƒãƒˆã—ãªã„å ´åˆã¯ä½æ‰€ã§å…¥åŠ›ï¼‰">
                <div class="route-buttons">
                    <div class="car">
                        <button type="button" onclick="route('car')">ğŸš™ è»Š</button>
                    </div>
                    <div class="walk">
                        <button type="button" onclick="route('foot')">ğŸš¶ å¾’æ­©</button>
                    </div>
                </div>

                

                <div id="route-selector" style="margin-top:15px;"></div> <!-- ãƒ«ãƒ¼ãƒˆ1,2,3ã®ãƒœã‚¿ãƒ³ -->
                <div id="route-info"></div>
                <div id="route-roads" style="margin-top:10px;"></div>
            </div>
        </div>
        <!-- åœ°å›³ -->
        <div id="map" style="height: 400px; width: 100%; margin-top: 20px;"></div>


        <button type="button" onclick="history.back()">
            â† æˆ»ã‚‹
        </button>
    </div>
    

</div>


<script>
    var lat = parseFloat("{{ spot.latitude|default:'0' }}");
    var lng = parseFloat("{{ spot.longitude|default:'0' }}");

    let map;
    let routeLines = [];
    let startMarker = null;
    let allRoutes = [];

    // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¤ã‚³ãƒ³
    const startIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    // ======================
    // åœ°å›³åˆæœŸåŒ–
    // ======================
    if (lat !== 0 && lng !== 0) {
        map = L.map('map').setView([lat, lng], 15);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        L.marker([lat, lng])
            .addTo(map)
            .bindPopup("{{ spot.spot_name }}");
    } else {
        document.getElementById("map").innerHTML =
            "<p style='text-align:center;'>åœ°å›³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</p>";
    }

    // ======================
    // ãƒ«ãƒ¼ãƒˆæ¤œç´¢
    // ======================
    window.route = function(mode) {
        const start = document.getElementById("start").value;
        if (!start) { alert("å‡ºç™ºåœ°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

        getLatLng(start)
            .then(([sLat, sLng]) => fetchRoutes(sLat, sLng, mode))
            .catch(() => alert("å‡ºç™ºåœ°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"));
    };

    // ======================
    // ãƒ«ãƒ¼ãƒˆå–å¾—
    // ======================
    function fetchRoutes(sLat, sLng, mode) {
        const profile = mode === "foot" ? "foot" : "car";

        fetch(`https://router.project-osrm.org/route/v1/${profile}/${sLng},${sLat};${lng},${lat}?alternatives=true&overview=full&geometries=geojson&steps=true`)
            .then(res => res.json())
            .then(data => {
                if (!data.routes || data.routes.length === 0) { alert("ãƒ«ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }

                allRoutes = [];

                if (mode === "foot") {
                    data.routes.forEach((route, index) => {
                        allRoutes.push({ route, type: "foot", index });
                    });
                } else {
                    data.routes.forEach((route, index) => {
                        let highwayDistance = 0;
                        route.legs[0].steps.forEach(step => {
                            const name = step.name || "";
                            const ref  = step.ref  || "";
                            if (name.includes("è‡ªå‹•è»Šé“") || /^E\d+/.test(ref)) highwayDistance += step.distance;
                        });
                        const highwayRatio = highwayDistance / route.distance;
                        allRoutes.push({ route, type: highwayRatio > 0.3 ? "highway" : "normal", highwayRatio, index });
                    });
                    allRoutes.sort((a,b) => a.highwayRatio - b.highwayRatio);
                }

                createRouteButtons(mode);
                drawRoute(allRoutes[0].route, allRoutes[0].type, mode);
                showRoads(allRoutes[0].route, allRoutes[0].type, mode);
            });
    }

    // ======================
    // ãƒ«ãƒ¼ãƒˆãƒœã‚¿ãƒ³ç”Ÿæˆ
    // ======================
    function createRouteButtons(mode) {
        const selectorDiv = document.getElementById("route-selector");
        selectorDiv.innerHTML = "";

        if (mode === "foot") {
            allRoutes.forEach((item, i) => {
                const btn = document.createElement("button");
                btn.classList.add("route-btn");
                btn.innerText = allRoutes.length > 1 ? `å¾’æ­©ãƒ«ãƒ¼ãƒˆ${i+1}` : "å¾’æ­©ãƒ«ãƒ¼ãƒˆ";
                btn.onclick = () => {
                    drawRoute(item.route, "foot", mode);
                    showRoads(item.route, "foot", mode);
                };
                selectorDiv.appendChild(btn);
            });
            return;
        }

        const highways = allRoutes.filter(r => r.type === "highway");
        const normals  = allRoutes.filter(r => r.type === "normal");

        highways.forEach((item, i) => {
            const btn = document.createElement("button");
            btn.innerText = highways.length === 1 ? "é«˜é€Ÿãƒ«ãƒ¼ãƒˆ" : `é«˜é€Ÿãƒ«ãƒ¼ãƒˆ${i+1}`;
            btn.onclick = () => {
                drawRoute(item.route, "highway", mode);
                showRoads(item.route, "highway", mode);
            };
            selectorDiv.appendChild(btn);
        });

        normals.forEach((item, i) => {
            const btn = document.createElement("button");
            btn.innerText = normals.length === 1 ? "ä¸€èˆ¬é“ãƒ«ãƒ¼ãƒˆ" : `ä¸€èˆ¬é“ãƒ«ãƒ¼ãƒˆ${i+1}`;
            btn.onclick = () => {
                drawRoute(item.route, "normal", mode);
                showRoads(item.route, "normal", mode);
            };
            selectorDiv.appendChild(btn);
        });
    }

    // ======================
    // ãƒ«ãƒ¼ãƒˆæç”»
    // ======================
    function drawRoute(route, type, mode) {
        routeLines.forEach(line => map.removeLayer(line));
        routeLines = [];

        if (startMarker) { map.removeLayer(startMarker); startMarker = null; }

        let coords = [];
        if (mode === "foot") {
            route.legs[0].steps.forEach(step => {
                const name = step.name || "", ref = step.ref || "";
                const isHighway = name.includes("è‡ªå‹•è»Šé“") || /^E\d+/.test(ref);
                if (!isHighway) step.geometry.coordinates.forEach(c => coords.push([c[1], c[0]]));
            });
        } else {
            coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
        }

        const lineStyle = {
            color: type === "highway" ? "#007bff" : type === "normal" ? "green" : "blue",
            weight: 5,
            dashArray: type === "foot" ? "8, 8" : null
        };

        const line = L.polyline(coords, lineStyle).addTo(map);
        routeLines.push(line);

        startMarker = L.marker(coords[0], {icon: startIcon}).addTo(map).bindPopup("å‡ºç™ºåœ°");

        const distanceKm = route.distance / 1000;
        const minutes = mode === "foot" ? Math.round((distanceKm / 4) * 60) : Math.round(route.duration / 60);

        document.getElementById("route-info").innerHTML =
            `è·é›¢: ${distanceKm.toFixed(1)} km<br>æ™‚é–“: ${minutes} åˆ†`;

        map.fitBounds(line.getBounds(), { padding: [50, 50], maxZoom: 20 });

        document.getElementById("map").scrollIntoView({ behavior: "smooth", block: "start" });
    }

    // ======================
    // é€šéé“è·¯è¡¨ç¤ºï¼ˆâ†’ã§çµ±ä¸€ï¼‰
    // ======================
    function showRoads(route, type, mode) {
        let highways = [], generalRoads = new Set();

        route.legs[0].steps.forEach(step => {
            const name = step.name || "", ref = step.ref || "";
            if (mode === "foot") { if (name) generalRoads.add(name); return; }
            const isHighway = name.includes("è‡ªå‹•è»Šé“") || /^E\d+/.test(ref);
            if (isHighway) highways.push(name || `é«˜é€Ÿé“è·¯(${ref})`);
            else {
                if (/^\d+$/.test(ref)) generalRoads.add(`å›½é“${ref}å·`);
                else if (name.includes("çœŒé“")) generalRoads.add(name);
            }
        });

        let html = "é€šéé“è·¯:<br>";
        if (mode === "foot") {
            html += `<strong>å¾’æ­©ãƒ«ãƒ¼ãƒˆ</strong><br>${[...generalRoads].slice(0,10).join(" â†’ ")}`;
        } else {
            if (type === "highway" && highways.length)
                html += `<strong>é«˜é€Ÿé“è·¯</strong><br>${[...new Set(highways)].join(" â†’ ")}`;
            if ((type === "normal" || type === "general") && generalRoads.size)
                html += `<strong>ä¸€èˆ¬é“</strong><br>${[...generalRoads].join(" â†’ ")}`;
        }

        document.getElementById("route-roads").innerHTML = html;
    }

    // ======================
    // ä½æ‰€â†’ç·¯åº¦çµŒåº¦
    // ======================
    function getLatLng(address) {
        return new Promise((resolve, reject) => {
            const hasNumber = /\d/.test(address);
            const url = hasNumber
                ? `https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(address)}`
                : `https://nominatim.openstreetmap.org/search?format=json&countrycodes=jp&limit=1&q=${encodeURIComponent(address)}`;
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (!data || data.length === 0) reject();
                    let lat, lng;
                    if (hasNumber) { lat = data[0].geometry.coordinates[1]; lng = data[0].geometry.coordinates[0]; }
                    else { lat = data[0].lat; lng = data[0].lon; }
                    resolve([lat, lng]);
                }).catch(() => reject());
        });
    }

    // ======================
    // å‘¨è¾ºæ–½è¨­è¡¨ç¤º
    // ======================    
    // 1. åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã«åºƒã„ç¯„å›²ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function loadOverpassData() {
    // ç¾åœ¨ã®è¡¨ç¤ºç¯„å›²
    const bbox = map.getBounds();

    // æ‹¡å¤§å€ç‡ï¼ˆ2ã€œ5 ãã‚‰ã„ãŒç¾å®Ÿçš„ï¼‰
    const expand = 3;

    // ä¸­å¿ƒåº§æ¨™
    const center = bbox.getCenter();

    // ç·¯åº¦ãƒ»çµŒåº¦ã®å·®åˆ†ã‚’æ‹¡å¤§
    const latDiff = (bbox.getNorth() - bbox.getSouth()) / 2 * expand;
    const lngDiff = (bbox.getEast() - bbox.getWest()) / 2 * expand;

    // æ‹¡å¤§å¾Œã® bbox
    const bigBbox = {
        south: center.lat - latDiff,
        west: center.lng - lngDiff,
        north: center.lat + latDiff,
        east: center.lng + lngDiff
    };

    // Overpass API ã‚¯ã‚¨ãƒª
    const query = `
    [out:json];
    (
        // restaurant / fast_food
        node["amenity"~"restaurant|fast_food"](${bigBbox.south},${bigBbox.west},${bigBbox.north},${bigBbox.east});
        way["amenity"~"restaurant|fast_food"](${bigBbox.south},${bigBbox.west},${bigBbox.north},${bigBbox.east});
        relation["amenity"~"restaurant|fast_food"](${bigBbox.south},${bigBbox.west},${bigBbox.north},${bigBbox.east});

        // hotel / guest_house
        node["tourism"~"hotel|guest_house"](${bigBbox.south},${bigBbox.west},${bigBbox.north},${bigBbox.east});
        way["tourism"~"hotel|guest_house"](${bigBbox.south},${bigBbox.west},${bigBbox.north},${bigBbox.east});
        relation["tourism"~"hotel|guest_house"](${bigBbox.south},${bigBbox.west},${bigBbox.north},${bigBbox.east});

        // convenience
        node["shop"="convenience"](${bigBbox.south},${bigBbox.west},${bigBbox.north},${bigBbox.east});
        way["shop"="convenience"](${bigBbox.south},${bigBbox.west},${bigBbox.north},${bigBbox.east});
        relation["shop"="convenience"](${bigBbox.south},${bigBbox.west},${bigBbox.north},${bigBbox.east});
    );
    out center;
    `;

    // ã‚¢ã‚¤ã‚³ãƒ³å®šç¾©
    const icons = {
        restaurant: L.icon({
        iconUrl: 'https://img.icons8.com/?size=100&id=fzBbztlzr6xk&format=png',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
        }),
        hotel: L.icon({
        iconUrl: 'https://img.icons8.com/?size=100&id=AVe9YeyAXTql&format=png&color=000000',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
        }),
        convenience: L.icon({
        iconUrl: 'https://img.icons8.com/?size=100&id=pmzAHWwbZBIP&format=png&color=000000',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
        })
    };

    // ãƒãƒ¼ã‚«ãƒ¼ã‚’ã¾ã¨ã‚ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼
    const markerLayer = L.layerGroup().addTo(map);

    // Overpass API å®Ÿè¡Œ
    fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: query
    })
        .then(res => res.json())
        .then(data => {
        const geojson = osmtogeojson(data);

        L.geoJSON(geojson, {
            pointToLayer: (feature, latlng) => {
            const tags = feature.properties.tags || feature.properties || {};
            let icon = icons.restaurant;

            if (tags.amenity === "restaurant" || tags.amenity === "fast_food") {
                icon = icons.restaurant;
            } else if (tags.tourism === "hotel" || tags.tourism === "guest_house") {
                icon = icons.hotel;
            } else if (tags.shop === "convenience") {
                icon = icons.convenience;
            }

            return L.marker(latlng, { icon });
            }
        }).addTo(markerLayer);
        })
        .catch(err => console.error(err));
    }

    // 2. ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã« 1 å›ã ã‘å®Ÿè¡Œ
    loadOverpassData();
</script>




{% endblock %}
{% block extra_js %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script src="https://unpkg.com/osmtogeojson/osmtogeojson.js"></script>
{% endblock %}
