{% extends "base/base.html" %}
{% load static %}

{% block title %}観光地詳細{% endblock %}

{% block extra_css %}
  <link href="{% static 'css/spot_detail.css' %}" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
{% endblock %}
{# ===== ナビを最小構成に差し替え ===== #}
{% block nav %}
<nav class="profile-mini-nav">
  <a href="{% url 'spotapp:index' %}" class="btn-home">ホーム</a>

  <div class="user-info">
    <div class="user-icon">
      {% if request.user.profile.icon %}
        <img src="{{ request.user.profile.icon.url }}" alt="icon">
      {% else %}
        <img src="{% static 'img/default_icon.png' %}" alt="icon">
      {% endif %}
    </div>
    <div class="user-name-text">
      {{ request.user.username }} さん
    </div>
  </div>
</nav>
{% endblock %}

{# ===== 検索バー・フッターは消す ===== #}
{% block searchbar %}{% endblock %}
{% block footer %}{% endblock %}

{% block body %}
<div class="page">

    <!-- 観光地情報 -->
    <div class="spot-info">
        <h1 class="spot-name">{{ spot.spot_name }}</h1>

        <div class="spot-image">
            {% if spot.spot_photos.all %}
                <div class="photo has-image">
                    <img
                        src="{{ spot.spot_photos.first.image.url }}"
                        alt="{{ spot.spot_name }}"
                        class="spot-img"
                    >
                </div>
            {% else %}
                <div class="photo no-image">
                    <img
                        src="{% static 'img/no-image.png' %}"
                        alt="no image"
                        class="spot-img"
                    >
                </div>
            {% endif %}
        </div>

        <div class="spot-actions" onclick="event.stopPropagation()">
            <button
                    id="fav-btn"
                    data-url="{% url 'spotapp:favorite_toggle_ajax' spot.spot_id %}"
                    class="fav-btn"
            >
                    {% if is_favorited %}
                        登録済み
                    {% else %}
                        お気に入り登録
                    {% endif %}
            </button>
        </div>

        <h2 class="spot-address">住所  {{ spot.address }}</h2>
        <h2 class="spot-hours">営業時間  {{ spot.business_hours }}</h2>

        
        <a href="{% url 'spotapp:review_detail' spot.spot_id %}"class="btn">
            レビューを見る
        </a>

        <div id="map" style="height: 400px; width: 100%; margin-top: 20px;"></div>


        <button type="button" onclick="history.back()">
            ← 戻る
        </button>
    </div>
    

</div>


<script>
    var lat = parseFloat("{{ spot.latitude|default:'0' }}");
    var lng = parseFloat("{{ spot.longitude|default:'0' }}");

    console.log(lat, lng);

    // 緯度経度がある場合のみ地図表示
    if (lat !== 0 && lng !== 0) {

        // ① 地図本体を生成（← これが抜けてた）
        var map = L.map('map').setView([lat, lng], 15);

        // ② タイルレイヤー追加
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        // ③ マーカー追加
        L.marker([lat, lng])
            .addTo(map)
            .bindPopup("{{ spot.spot_name }}");

    } else {
        document.getElementById("map").innerHTML =
            "<p style='text-align:center;'>地図情報がありません</p>";
    }
</script>

{% endblock %}
{% block extra_js %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
{% endblock %}
