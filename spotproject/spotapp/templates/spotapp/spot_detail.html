{% extends "base/base.html" %}
{% load static %}

{% block title %}è¦³å…‰åœ°è©³ç´°{% endblock %}

{% block extra_css %}
  <link href="{% static 'css/spot_detail.css' %}" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
{% endblock %}
{# ===== ãƒŠãƒ“ã‚’æœ€å°æ§‹æˆã«å·®ã—æ›¿ãˆ ===== #}
{% block nav %}
<nav class="profile-mini-nav">
  <a href="{% url 'spotapp:index' %}" class="btn-home">ãƒ›ãƒ¼ãƒ </a>

  <div class="user-info">
    <div class="user-icon">
      {% if request.user.profile.icon %}
        <img src="{{ request.user.profile.icon.url }}" alt="icon">
      {% else %}
        <img src="{% static 'img/default_icon.png' %}" alt="icon">
      {% endif %}
    </div>
    <div class="user-name-text">
      {{ request.user.username }} ã•ã‚“
    </div>
  </div>
</nav>
{% endblock %}

{# ===== æ¤œç´¢ãƒãƒ¼ãƒ»ãƒ•ãƒƒã‚¿ãƒ¼ã¯æ¶ˆã™ ===== #}
{% block searchbar %}{% endblock %}
{% block footer %}{% endblock %}

{% block body %}
<div class="page">

    <!-- è¦³å…‰åœ°æƒ…å ± -->
    <div class="spot-info">
        <h1 class="spot-name">{{ spot.spot_name }}</h1>

        <div class="spot-image">
            {% if spot.spot_photos.all %}
                <div class="photo has-image">
                    <img
                        src="{{ spot.spot_photos.first.image.url }}"
                        alt="{{ spot.spot_name }}"
                        class="spot-img"
                    >
                </div>
            {% else %}
                <div class="photo no-image">
                    <img
                        src="{% static 'img/no-image.png' %}"
                        alt="no image"
                        class="spot-img"
                    >
                </div>
            {% endif %}
        </div>

        <div class="spot-actions" onclick="event.stopPropagation()">
            <button
                    id="fav-btn"
                    data-url="{% url 'spotapp:favorite_toggle_ajax' spot.spot_id %}"
                    class="fav-btn"
            >
                    {% if is_favorited %}
                        ç™»éŒ²æ¸ˆã¿
                    {% else %}
                        ãŠæ°—ã«å…¥ã‚Šç™»éŒ²
                    {% endif %}
            </button>
        </div>

        <h2 class="spot-address">ä½æ‰€  {{ spot.address }}</h2>
        <h2 class="spot-hours">å–¶æ¥­æ™‚é–“  {{ spot.business_hours }}</h2>

        
        <a href="{% url 'spotapp:review_detail' spot.spot_id %}"class="btn">
            ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦‹ã‚‹
        </a>

        <!-- ãƒ«ãƒ¼ãƒˆæ¡ˆå†…ãƒ»æ™‚é–“è¡¨ç¤º -->
        
        <div id="route-ui">
            <div class="route-input">
                <input id="start" type="text" placeholder="å‡ºç™ºåœ°ã‚’å…¥åŠ›ï¼ˆãƒ’ãƒƒãƒˆã—ãªã„å ´åˆã¯ä½æ‰€ã§å…¥åŠ›ï¼‰">
                <div class="route-buttons">
                    <div class="walk">
                        <button type="button" onclick="route('car')">ğŸš™ è»Š</button>
                    </div>
                    <div class="car">
                        <button type="button" onclick="route('foot')">ğŸš¶ å¾’æ­©</button>
                    </div>
                </div>
                <div id="route-info"></div>
            </div>
        </div>
        <!-- åœ°å›³ -->
        <div id="map" style="height: 400px; width: 100%; margin-top: 20px;"></div>


        <button type="button" onclick="history.back()">
            â† æˆ»ã‚‹
        </button>
    </div>
    

</div>


<script>
    var lat = parseFloat("{{ spot.latitude|default:'0' }}");
    var lng = parseFloat("{{ spot.longitude|default:'0' }}");

    console.log(lat, lng);

    // ç·¯åº¦çµŒåº¦ãŒã‚ã‚‹å ´åˆã®ã¿åœ°å›³è¡¨ç¤º
    if (lat !== 0 && lng !== 0) {

        // â‘  åœ°å›³æœ¬ä½“ã‚’ç”Ÿæˆï¼ˆâ† ã“ã‚ŒãŒæŠœã‘ã¦ãŸï¼‰
        var map = L.map('map').setView([lat, lng], 15);

        // â‘¡ ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        // â‘¢ ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ 
        L.marker([lat, lng])
            .addTo(map)
            .bindPopup("{{ spot.spot_name }}");

    } else {
        document.getElementById("map").innerHTML =
            "<p style='text-align:center;'>åœ°å›³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</p>";
    }

    let routingControl;

    function route(mode) {
        const start = document.getElementById("start").value;
        if (!start) {
            alert("å‡ºç™ºåœ°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
        }

        // ç•ªåœ°ã£ã½ã„æ–‡å­—ãŒã‚ã‚‹å ´åˆã¯GSIä½æ‰€æ¤œç´¢
        const hasNumber = /\d/.test(start);

        if (hasNumber) {
            // GSIä½æ‰€æ¤œç´¢
            fetch(`https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(start)}`)
                .then(res => res.json())
                .then(data => {
                    if (!data || data.length === 0) {
                        alert("å‡ºç™ºåœ°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                        return;
                    }
                    const sLat = data[0].geometry.coordinates[1];
                    const sLng = data[0].geometry.coordinates[0];
                    createRoute(sLat, sLng, mode);
                });
        } else {
            // å»ºç‰©åãªã©ã¯OSMæ¤œç´¢
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(start)}`)
                .then(res => res.json())
                .then(data => {
                    if (!data || data.length === 0) {
                        alert("å‡ºç™ºåœ°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                        return;
                    }
                    const sLat = parseFloat(data[0].lat);
                    const sLng = parseFloat(data[0].lon);
                    createRoute(sLat, sLng, mode);
                });
        }
    }

    function createRoute(sLat, sLng, mode) {
        if (routingControl) map.removeControl(routingControl);

        routingControl = L.Routing.control({
            router: L.Routing.osrmv1({
                serviceUrl: 'https://router.project-osrm.org/route/v1',
                profile: mode === "car" ? "car" : "foot"
            }),
            waypoints: [
                L.latLng(sLat, sLng),  // å‡ºç™ºåœ°
                L.latLng(lat, lng)     // è¦³å…‰åœ°ï¼ˆç›®çš„åœ°ï¼‰
            ],
            lineOptions: { styles: [{ color: 'blue', weight: 5 }] },
            addWaypoints: false,
            draggableWaypoints: false,
            show: false,
        }).addTo(map);

        routingControl.on('routesfound', function(e) {
            const r = e.routes[0];
            const distanceKm = r.summary.totalDistance / 1000;
            let minutes = mode === "car" ? Math.round(r.summary.totalTime / 60) : Math.round((distanceKm / 4) * 60);

            document.getElementById("route-info").innerHTML =
                `è·é›¢: ${distanceKm.toFixed(1)} km<br>æ™‚é–“: ${minutes} åˆ†`;

            map.fitBounds(L.latLngBounds(r.coordinates));
        });
    } 

</script>

{% endblock %}
{% block extra_js %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
{% endblock %}
