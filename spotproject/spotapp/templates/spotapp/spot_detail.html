{% extends "base/base.html" %}
{% load static %}

{% block title %}è¦³å…‰åœ°è©³ç´°{% endblock %}

{% block extra_css %}
  <link href="{% static 'css/spot_detail.css' %}" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
{% endblock %}
{# ===== ãƒŠãƒ“ã‚’æœ€å°æ§‹æˆã«å·®ã—æ›¿ãˆ ===== #}
{% block nav %}
<nav class="profile-mini-nav">
  <a href="{% url 'spotapp:index' %}" class="btn-home">ãƒ›ãƒ¼ãƒ </a>

  <div class="user-info">
    <div class="user-icon">
      {% if request.user.profile.icon %}
        <img src="{{ request.user.profile.icon.url }}" alt="icon">
      {% else %}
        <img src="{% static 'img/default_icon.png' %}" alt="icon">
      {% endif %}
    </div>
    <div class="user-name-text">
      {{ request.user.username }} ã•ã‚“
    </div>
  </div>
</nav>
{% endblock %}

{# ===== æ¤œç´¢ãƒãƒ¼ãƒ»ãƒ•ãƒƒã‚¿ãƒ¼ã¯æ¶ˆã™ ===== #}
{% block searchbar %}{% endblock %}
{% block footer %}{% endblock %}

{% block body %}
<div class="page">

    <!-- è¦³å…‰åœ°æƒ…å ± -->
    <div class="spot-info">
        <h1 class="spot-name">{{ spot.spot_name }}</h1>

        <div class="spot-image">
            {% if spot.spot_photos.all %}
                <div class="photo has-image">
                    <img
                        src="{{ spot.spot_photos.first.image.url }}"
                        alt="{{ spot.spot_name }}"
                        class="spot-img"
                    >
                </div>
            {% else %}
                <div class="photo no-image">
                    <img
                        src="{% static 'img/no-image.png' %}"
                        alt="no image"
                        class="spot-img"
                    >
                </div>
            {% endif %}
        </div>

        <div class="spot-actions" onclick="event.stopPropagation()">
            <button
                    id="fav-btn"
                    data-url="{% url 'spotapp:favorite_toggle_ajax' spot.spot_id %}"
                    class="fav-btn"
            >
                    {% if is_favorited %}
                        ç™»éŒ²æ¸ˆã¿
                    {% else %}
                        ãŠæ°—ã«å…¥ã‚Šç™»éŒ²
                    {% endif %}
            </button>
        </div>

        <h2 class="spot-address">ä½æ‰€<br>{{ spot.address }}</h2>
        <h2 class="spot-hours">å–¶æ¥­æ™‚é–“<br>{{ spot.business_hours }}</h2>

        
        <a href="{% url 'spotapp:review_detail' spot.spot_id %}"class="btn">
            ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦‹ã‚‹
        </a>

        <!-- ãƒ«ãƒ¼ãƒˆæ¡ˆå†…ãƒ»æ™‚é–“è¡¨ç¤º -->
        
        <div id="route-ui">
            <div class="route-input">
                <input id="start" type="text" placeholder="å‡ºç™ºåœ°ã‚’å…¥åŠ›ï¼ˆãƒ’ãƒƒãƒˆã—ãªã„å ´åˆã¯ä½æ‰€ã§å…¥åŠ›ï¼‰">
                <div class="route-buttons">
                    <div class="walk">
                        <button type="button" onclick="route('car')">ğŸš™ è»Š</button>
                    </div>
                    <div class="car">
                        <button type="button" onclick="route('foot')">ğŸš¶ å¾’æ­©</button>
                    </div>
                </div>
                <div id="route-selector" style="margin-top:15px;"></div> <!-- ãƒ«ãƒ¼ãƒˆ1,2,3ã®ãƒœã‚¿ãƒ³ -->
                <div id="route-info"></div>
            </div>
        </div>
        <!-- åœ°å›³ -->
        <div id="map" style="height: 400px; width: 100%; margin-top: 20px;"></div>


        <button type="button" onclick="history.back()">
            â† æˆ»ã‚‹
        </button>
    </div>
    

</div>


<script>
    var lat = parseFloat("{{ spot.latitude|default:'0' }}");
    var lng = parseFloat("{{ spot.longitude|default:'0' }}");

    console.log(lat, lng);

    // ç·¯åº¦çµŒåº¦ãŒã‚ã‚‹å ´åˆã®ã¿åœ°å›³è¡¨ç¤º
    if (lat !== 0 && lng !== 0) {

        // â‘  åœ°å›³æœ¬ä½“ã‚’ç”Ÿæˆï¼ˆâ† ã“ã‚ŒãŒæŠœã‘ã¦ãŸï¼‰
        var map = L.map('map').setView([lat, lng], 15);

        // â‘¡ ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        // â‘¢ ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ 
        L.marker([lat, lng])
            .addTo(map)
            .bindPopup("{{ spot.spot_name }}");

    } else {
        document.getElementById("map").innerHTML =
            "<p style='text-align:center;'>åœ°å›³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</p>";
    }

    let routeLines = [];        // ãƒ«ãƒ¼ãƒˆã®è¡¨ç¤ºã®é’ã„ç·š
    let alternativeRoutes = []; // 2ã¤ã®ãƒ«ãƒ¼ãƒˆã‚’æ ¼ç´
    let selectedRouteIndex = 0; //ä»Šé¸ã°ã‚Œã¦ã‚‹ãƒãƒƒãƒ—

    window.route = function(mode) { //modeã¯è»Šã‹å¾’æ­©ã¨ã‹ã®é¸æŠ
        // å…¥åŠ›ã•ã‚ŒãŸä½æ‰€ã¾ãŸã¯å»ºç‰©åç§°
        const start = document.getElementById("start").value;

        // ä½•ã‚‚å…¥åŠ›ã•ã‚Œã¦ãªã‹ã£ãŸã‚‰ã“ã®æ–‡å­—ã‚’è¡¨ç¤ºã™ã‚‹
        if (!start) { alert("å‡ºç™ºåœ°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

        // å‡ºç™ºåœ°ã‚’çµŒåº¦ç·¯åº¦ã«å¤‰æ›ã—ã¦æ¤œç´¢ã‚’ã—ã¦ã„ã‚‹å‡¦ç†
        getLatLng(start).then(([sLat,sLng]) => {

            // çµŒåº¦ç·¯åº¦ã®å–å¾—ã«æˆåŠŸã—ãŸã‚‰å¤‰æ•°ã«çµŒåº¦ç·¯åº¦ã‚’ä»£å…¥ã—ã¦ã€ã“ã®é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ã€‚modeã¯ç§»å‹•æ‰‹æ®µ
            fetchRoutes(sLat, sLng, mode);
            // è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚‰ã“ã®æ–‡å­—ã‚’è¡¨ç¤ºã™ã‚‹
        }).catch(() => alert("å‡ºç™ºåœ°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"));
    };

    // ã“ã®é–¢æ•°ã¯å‡ºç™ºåœ°ï¼ˆçµŒåº¦ãƒ»ç·¯åº¦ï¼‰ã¨ç§»å‹•æ‰‹æ®µï¼ˆmodeï¼‰ã‚’ã‚‚ã¨ã«
    // OSRMã¨ã„ã†ç„¡æ–™ã®ãƒ«ãƒ¼ãƒˆè¨ˆç®—ã‚µãƒ¼ãƒãƒ¼ã«æœ€é©ãƒ«ãƒ¼ãƒˆã‚’æ•™ãˆã¦ã‚‚ã‚‰ã£ã¦ã€çµæœï¼ˆæœ€é©ãƒ«ãƒ¼ãƒˆï¼‰ã‚’å–å¾—ã—ã€å‡¦ç†ã™ã‚‹
    function fetchRoutes(sLat, sLng, mode) {

        // OSRMã®ãƒ«ãƒ¼ãƒˆè¨ˆç®—APIã®URLã«ç§»å‹•æ‰‹æ®µï¼ˆmodeï¼‰ã€çµŒåº¦ï¼ˆsLngï¼‰ã€ç·¯åº¦ï¼ˆsLatï¼‰ã§ã€ç›®çš„åœ°ï¼ˆlng,latï¼‰ã§
        //ã€€ãƒ«ãƒ¼ãƒˆã‚’æ•™ãˆã¦ã‚‚ã‚‰ã£ã¦ã„ã‚‹
        fetch(`https://router.project-osrm.org/route/v1/${mode}/${sLng},${sLat};${lng},${lat}?alternatives=true&overview=full&geometries=geojson`)
        // alternatives=true â†’ æœ€é©ãƒ«ãƒ¼ãƒˆä»¥å¤–ã«ã‚‚ä»£æ›¿ãƒ«ãƒ¼ãƒˆã‚’è¤‡æ•°
        // overview=full â†’ é“ã«æ²¿ã£ãŸç·š
        // geometries=geojson â†’ ãƒ«ãƒ¼ãƒˆã®åº§æ¨™ã‚’GeoJSONå½¢å¼ã§è¿”ã™ï¼ˆLeaflet.jsã§æãã‚„ã™ã„ï¼‰

        // çµæœï¼ˆãƒ«ãƒ¼ãƒˆï¼‰ãŒããŸã‚‰ã€json()ã§ä¸­èº«ã‚’JavaScriptã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
        .then(res => res.json())

        .then(data => {
            // dataã®ä¸­èº«ï¼ˆdistance: è·é›¢ã€duration: æ‰€è¦æ™‚é–“ã€geometry: ãƒ«ãƒ¼ãƒˆã®å½¢çŠ¶ï¼‰
            if (!data.routes || data.routes.length === 0) { alert("ãƒ«ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }

            // æœ€å¤§3ãƒ«ãƒ¼ãƒˆ
            alternativeRoutes = data.routes.slice(0,3);

            // æ™‚é–“ãŒæœ€ã‚‚çŸ­ã„ãƒ«ãƒ¼ãƒˆã‚’è‡ªå‹•é¸æŠ
            selectedRouteIndex = 0;
            let minTime = alternativeRoutes[0].duration;
            alternativeRoutes.forEach((r, i)=>{
                if(r.duration < minTime) { 
                    minTime = r.duration; 
                    selectedRouteIndex = i;
                }
            });

            createRouteButtons(mode); // â† mode ã‚’æ¸¡ã™
            drawRoute(alternativeRoutes[selectedRouteIndex], mode); // â† mode ã‚’æ¸¡ã™
        });
    }

    // ãƒ«ãƒ¼ãƒˆ1ã€ãƒ«ãƒ¼ãƒˆ2ãªã©ã®ãƒœã‚¿ãƒ³ã‚’ä½œã‚‹é–¢æ•°
    function createRouteButtons(mode) {
        
        //HTMLã‹ã‚‰route-selectorã¨ã†idå±æ€§ã‚’å–å¾—ã™ã‚‹
        const selectorDiv = document.getElementById("route-selector");

        // åˆæœŸå€¤ã¯ç©ºï¼ˆä½•ã‚‚è¡¨ç¤ºã•ã‚Œã¦ã„ãªã„ï¼‰
        selectorDiv.innerHTML = "";

        // å–å¾—ã—ãŸãƒ«ãƒ¼ãƒˆã‚’ãƒ«ãƒ¼ãƒ—ã§æ¢ã—ã¦ã€
        alternativeRoutes.forEach((route, index)=>{
            const btn = document.createElement("button");
            btn.innerText = `ãƒ«ãƒ¼ãƒˆ${index+1}`;
            btn.style.marginRight = "10px";
            btn.onclick = () => drawRoute(alternativeRoutes[index], mode); // â† mode ã‚’æ¸¡ã™
            selectorDiv.appendChild(btn);
        });
    }


    let startMarker = null; // ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã®ãƒãƒ¼ã‚«ãƒ¼ä¿æŒç”¨

    // ã“ã®é–¢æ•°ã¯é¸ã°ã‚ŒãŸ1ã¤ã®ãƒ«ãƒ¼ãƒˆã‚’åœ°å›³ä¸Šã«æç”»ã—ã€ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ç‚¹ã«èµ¤ã„ãƒ”ãƒ³ã‚’ç«‹ã¦ã€
    // è·é›¢ã¨æ™‚é–“ã‚’è¡¨ç¤ºã™ã‚‹
    function drawRoute(route, mode) {

        // æ—¢å­˜ãƒ«ãƒ¼ãƒˆå‰Šé™¤
        routeLines.forEach(line => map.removeLayer(line));
        routeLines = [];

        // æ—¢å­˜ã‚¹ã‚¿ãƒ¼ãƒˆãƒãƒ¼ã‚«ãƒ¼å‰Šé™¤
        if (startMarker) {
            map.removeLayer(startMarker);
            startMarker = null;
        }


        const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
        const line = L.polyline(coords, {color:'blue', weight:5}).addTo(map);
        routeLines.push(line);

        // ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã«èµ¤ã„ãƒ”ãƒ³ã‚’ç«‹ã¦ã‚‹
        const startLatLng = coords[0]; // ãƒ«ãƒ¼ãƒˆã®æœ€åˆã®åº§æ¨™

        // èµ¤ã„ãƒ”ãƒ³ã‚’æŒã£ã¦ãã¦ã„ã‚‹ã€‚ãŠã¾ã‘ã§å½±ã¨ã‹ã‚‚
        startMarker = L.marker(startLatLng, {icon: L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        })}).addTo(map).bindPopup("å‡ºç™ºåœ°");

        const distanceKm = route.distance / 1000;

        // å¾’æ­©ãªã‚‰æ™‚é€Ÿ4kmã§è¨ˆç®—
        let minutes;
        if (mode === "foot") {
            minutes = Math.round((distanceKm / 4) * 60); // å¾’æ­©: æ™‚é€Ÿ4km
        } else {
            minutes = Math.round(route.duration / 60);   // è»Š: OSRMã®å€¤
        }

        document.getElementById("route-info").innerHTML =
            `è·é›¢: ${distanceKm.toFixed(1)} km<br>æ™‚é–“: ${minutes} åˆ†`;

        map.fitBounds(line.getBounds());
    }

    // ã“ã®é–¢æ•°ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸä½æ‰€ã‚’çµŒåº¦ã¨ç·¯åº¦ã®æ•°å­—ã®ãƒšã‚¢ã«å¤‰æ›ã™ã‚‹
    function getLatLng(address){

        // æˆåŠŸã—ãŸã‚‰resolveã«çµŒåº¦ç·¯åº¦ã‚’æ¸¡ã™ã€å¤±æ•—ã—ãŸã‚‰rejectã§ã‚¨ãƒ©ãƒ¼ã«ã™ã‚‹
        return new Promise((resolve, reject)=>{

            // å…¥åŠ›ã«æ­£è¦è¡¨ç¾ã§æ•°å­—ãŒ1ã¤ã§ã‚‚å…¥ã£ã¦ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯
            const hasNumber = /\d/.test(address);

            // æ•°å­—ãŒå…¥ã£ã¦ã„ãŸã‚‰å›½åœŸåœ°ç†é™¢(GSI)ã®ä½æ‰€æ¤œç´¢APIã‚’ä½¿ã†
            // æ•°å­—ãŒå…¥ã£ã¦ã„ãªã‹ã£ãŸã‚‰ã‚ªãƒ¼ãƒ—ãƒ³ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒãƒƒãƒ—ï¼ˆNominatimï¼‰æ¤œç´¢APIã‚’ä½¿ã†
            const url = hasNumber
                ? `https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(address)}`
                : `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;

            fetch(url)
            .then(res => res.json())
            .then(data => {

                // ãƒ‡ãƒ¼ã‚¿ãŒç©ºã€ã¾ãŸã¯é…åˆ—ãŒ0ã ã£ãŸã‚‰rejectã‚’å‘¼ã‚“ã§ã‚¨ãƒ©ãƒ¼ã«ã™ã‚‹
                if (!data || data.length === 0) return reject();

                // çµŒåº¦ãƒ»ç·¯åº¦
                let lat, lng;

                // GSIï¼ˆå›½åœŸåœ°ç†é™¢ã®å ´åˆï¼‰
                if (hasNumber) {
                    // GSI ã¯ [lng, lat]
                    lat = parseFloat(data[0].geometry.coordinates[1]);
                    lng = parseFloat(data[0].geometry.coordinates[0]);
                } else { // ã‚ªãƒ¼ãƒ—ãƒ³ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒãƒƒãƒ—ã®å ´åˆ
                    // OSM
                    lat = parseFloat(data[0].lat);
                    lng = parseFloat(data[0].lon);
                }

                // æˆåŠŸã—ãŸã‚‰çµŒåº¦ç·¯åº¦ã‚’è¿”ã™
                resolve([lat, lng]);
            })
            .catch(err => reject());
        });
    }



</script>

{% endblock %}
{% block extra_js %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
{% endblock %}
