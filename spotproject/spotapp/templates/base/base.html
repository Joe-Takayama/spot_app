    {% load static %}
    <!DOCTYPE html>
    <html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{%  block title %}メニューHTML{% endblock %}</title>
        <!--共通css-->
        <link href="{% static 'css/style.css' %}" rel="stylesheet">
        <!--テンプレごとのcss-->
        {% block extra_css %} {% endblock %}
        {% block extra_js %}{% endblock %}

    </head>
    <body>


            <!-- ナビ -->
    {% block nav %}
    <nav>
        <div class="nav-left">
            <a href="{% url 'spotapp:index' %}" class="btn-home">ホーム</a>
        </div>

        <div class="nav-center">
            <div class="Nav-block" id="areaMenu_btn">
                <button class="Menu_btn" type="button" id="districtBtn">
                    {{ selected_district_name|default:"地区別" }} ▼
                </button>

                <ul class="menu_down" id="areaMenu_down">
                    <li><a href="#" class="district-item" data-value="" data-label="地区別">地区別</a></li>
                    {% for district in districts %}
                    <li>
                        <a href="#"
                            class="district-item"
                            data-value="{{ district.district_id }}"
                            data-label="{{ district.district_name }}">
                            {{ district.district_name }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>

        <div class="Nav-block" id="categoryMenu_btn">
            <button class="Menu_btn" type="button" id="categoryBtn">
                {{ selected_category_name|default:"カテゴリ" }} ▼
            </button>

            <ul class="menu_down" id="categoryMenu_down">
                <li><a href="#" class="category-item" data-value="" data-label="カテゴリ">カテゴリ</a></li>
                {% for category in categories %}
                    <li>
                        <a href="#"
                           class="category-item"
                           data-value="{{ category.category_id }}"
                           data-label="{{ category.category_name }}">
                            {{ category.category_name }}
                        </a>
                    </li>
                {% endfor %}
            </ul>
        </div>

        <div class="Nav-block osirase-block" id="osirase_btn">
            <button class="Menu_btn" type="button" id="osiraseBtn">
                お知らせ ▼
            </button>

            <ul class="menu_down" id="osirase_down">
                <li><a href="{% url 'spotapp:about' %}">サイトについて</a></li>
                <li><a href="{% url 'spotapp:contact' %}">お問い合わせ</a></li>
            </ul>
        </div>
        </div>

        <div class="nav-right">
            {% if request.user.is_authenticated %}
            <button type="button" class="user-btn" id="userMenuBtn">
                <div class="user-icon">
                    {% if request.user.profile.icon %}
                        <img src="{{ request.user.profile.icon.url }}" alt="icon">
                    {% else %}
                        <img src="{% static 'img/default_icon.png' %}" alt="icon">
                    {% endif %}
                </div>
                <div class="user-name-text">{{ request.user.username }} さん</div>
            </button>

            <div class="user-menu" id="userMenu">
                <a href="{% url 'users:profile' %}">プロフィール</a>
                <a href="{% url 'users:password_change' %}">パスワード変更</a>
                <a href="{% url 'users:logout' %}">ログアウト</a>
            </div>
            {% else %}
                <a href="{% url 'users:login' %}" class="user-btn">ログイン</a>
            {% endif %}
        </div>
    </nav>
    {% endblock %}

    {% block searchbar %}
    <div class="searchbar">
        <form method="get" action="{% url 'spotapp:spot_search' %}" class="search-form">
            <input type="text" name="q" placeholder="検索" class="search-input" value="{{ request.GET.q|default:'' }}">

            <input type="hidden" id="search_district" name="district" value="{{ request.GET.district|default:'' }}">
            <input type="hidden" id="search_category" name="category" value="{{ request.GET.category|default:'' }}">

            <button type="submit" class="search-btn">検索</button>
        </form>
    </div>
    {% endblock %}

    {% block body %}{% endblock %}

<script>
  document.addEventListener("DOMContentLoaded", function () {

    // ------------------------
    // ユーザーメニュー
    // ------------------------
    const menuBtn = document.getElementById("userMenuBtn");
    const menu = document.getElementById("userMenu");

    // user menu は存在するページだけ動かす（無いページでも他JSは動かす）
    if (menuBtn && menu) {
      menuBtn.addEventListener("click", function(e) {
        e.stopPropagation();
        menu.style.display = (menu.style.display === "flex") ? "none" : "flex";
      });

      document.addEventListener("click", function() {
        if (menu.style.display === "flex") {
          menu.style.display = "none";
        }
        // ナビのプルダウン全部閉じる
        document.querySelectorAll(".Nav-block.open").forEach(b => b.classList.remove("open"));
      });
    }

    // ------------------------
    // お気に入り（画面遷移なし / Ajax）
    // 使い方: <button type="button" class="fav-btn" data-url="...">お気に入り登録</button>
    // ------------------------
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');

    document.addEventListener("click", async function (e) {
      const btn = e.target.closest(".fav-btn");
      if (!btn) return;

      // 親の onclick（カード遷移）より先に止める
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();

      const url = btn.dataset.url;
      if (!url) return;

      btn.disabled = true;
      try {
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "X-CSRFToken": csrftoken,
            "Accept": "application/json",
          },
        });

        if (!res.ok) {
            const t = await res.text();
            console.log("favorite ajax failed:", res.status, t);
            alert(`favorite失敗: ${res.status}`);
            return;
        }

        const data = await res.json();

        // 表示更新（ボタン文言）
        if (data.favorited === true) btn.textContent = "お気に入り解除";
        else btn.textContent = "お気に入り登録";

      } catch (err) {
        console.log(err);
        alert("favorite通信エラー");
      } finally {
        btn.disabled = false;
      }
    });

    // ------------------------
    // 検索バー（地区/カテゴリ）とナビの連動
    // ------------------------
    const districtHidden = document.getElementById("search_district");
    const categoryHidden = document.getElementById("search_category");

    const districtBtn = document.getElementById("districtBtn");
    const categoryBtn = document.getElementById("categoryBtn");

    // ------------------------
    // 地区別ボタンの色を「県北/県南/県央/県東/県西」で切り替え
    // ------------------------
    function districtClassFromLabel(label) {
      if (!label) return "";
      if (label.includes("県北")) return "district-north";
      if (label.includes("県南")) return "district-south";
      if (label.includes("県央")) return "district-central";
      if (label.includes("県東")) return "district-east";
      if (label.includes("県西")) return "district-west";
      return "";
    }

    function applyDistrictColor(label) {
      if (!districtBtn) return;
      // 既存の district-* を全部外す
      districtBtn.classList.remove(
        "district-north",
        "district-south",
        "district-central",
        "district-east",
        "district-west"
      );

      const cls = districtClassFromLabel(label);
      if (cls) districtBtn.classList.add(cls);
    }

    function setSelectedDistrictInMenu(value) {
      // value が空なら「地区別」を選択状態に
      document.querySelectorAll(".district-item").forEach(a => {
        const v = a.dataset.value || "";
        if ((value || "") === v) a.classList.add("is-selected");
        else a.classList.remove("is-selected");
      });
    }

    // 地区
    document.querySelectorAll(".district-item").forEach(a => {
        a.addEventListener("click", (e) => {
        e.preventDefault();       // ← 遷移（検索）を止める
        e.stopPropagation();

        const val = a.dataset.value || "";
        const label = a.dataset.label || "地区別";

        if (districtHidden) districtHidden.value = val;
        if (districtBtn) districtBtn.textContent = `${label} ▼`;

        // ★追加：色を切り替え
        applyDistrictColor(label);

        // ★追加：メニュー内の選択状態
        setSelectedDistrictInMenu(val);
        });
    });

    // 初期表示でも反映（SSRで selected_district_name が入ってる想定）
    if (districtBtn) {
      const initialLabel = districtBtn.textContent.replace("▼", "").trim();
      applyDistrictColor(initialLabel);
      if (districtHidden) setSelectedDistrictInMenu(districtHidden.value);
    }

    // カテゴリ
    document.querySelectorAll(".category-item").forEach(a => {
        a.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();

        const val = a.dataset.value || "";
        const label = a.dataset.label || "カテゴリ";

        if (categoryHidden) categoryHidden.value = val;
        if (categoryBtn) categoryBtn.textContent = `${label} ▼`;
        });
    });

    // ------------------------
    // ナビのプルダウン：基本クリック
    // ただし「お知らせ」は PC=hover / スマホ=click
    // ------------------------
    const navBlocks = document.querySelectorAll(".Nav-block");
    const canHover = window.matchMedia("(hover: hover) and (pointer: fine)").matches;

    navBlocks.forEach(block => {
      const btn = block.querySelector(".Menu_btn");
      if (!btn) return;

      const isOsirase = (block.id === "osirase_btn");

      if (isOsirase && canHover) {
        // PC：hoverで開閉
        block.addEventListener("mouseenter", () => block.classList.add("open"));
        block.addEventListener("mouseleave", () => block.classList.remove("open"));
      } else {
        // スマホ or 通常：clickで開閉
        btn.addEventListener("click", (e) => {
          e.stopPropagation();

          // 他のプルダウン閉じる
          navBlocks.forEach(b => { if (b !== block) b.classList.remove("open"); });

          block.classList.toggle("open");
        });
      }
    });

    // ナビ外クリックで閉じる（user menu が無いページでも閉じる）
    document.addEventListener("click", function() {
      document.querySelectorAll(".Nav-block.open").forEach(b => b.classList.remove("open"));
    });

  });
</script>

    </body>
    </html>
