    {% load static %}
    <!DOCTYPE html>
    <html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{%  block title %}メニューHTML{% endblock %}</title>
        <!--共通css-->
        <link href="{% static 'css/style.css' %}" rel="stylesheet">
        <!--テンプレごとのcss-->
        {% block extra_css %} {% endblock %}
        {% block extra_js %}{% endblock %}

    </head>
    <body>


            <!-- ナビ -->
    {% block nav %}
    <nav>
        <div class="nav-left">
            <a href="{% url 'spotapp:index' %}" class="btn-home">ホーム</a>
        </div>

        <div class="nav-center">
            <div class="Nav-block" id="areaMenu_btn">
                <button class="Menu_btn" type="button" id="districtBtn">
                    {{ selected_district_name|default:"地区別" }} ▼
                </button>

                <ul class="menu_down" id="areaMenu_down">
                    <li><a href="#" class="district-item" data-value="" data-label="地区別">地区別</a></li>
                    {% for district in districts %}
                    <li>
                        <a href="#"
                            class="district-item"
                            data-value="{{ district.district_id }}"
                            data-label="{{ district.district_name }}">
                            {{ district.district_name }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>

        <div class="Nav-block" id="categoryMenu_btn">
            <button class="Menu_btn" type="button" id="categoryBtn">
                {{ selected_category_name|default:"カテゴリ" }} ▼
            </button>

            <ul class="menu_down" id="categoryMenu_down">
                <li><a href="#" class="category-item" data-value="" data-label="カテゴリ">カテゴリ</a></li>
                {% for category in categories %}
                    <li>
                        <a href="#"
                            class="category-item"
                            data-value="{{ category.category_id }}"
                            data-label="{{ category.category_name }}">
                            {{ category.category_name }}
                        </a>
                    </li>
                {% endfor %}
            </ul>
        </div>


            <!-- ログインしなきゃ表示できない奴 -->
            {% if user.is_authenticated %}
            <a href="{% url 'spotapp:favorite_list' %}" class="Menu_btn">
                お気に入り一覧
            </a>
            {% else %}
                
            {% endif %}
       


             <div class="Nav-block">
                <button class="Menu_btn">お知らせ ▼</button>
            
            <ul  id="osirase_down" class="menu_down anywhere">
                {% for o in osirase_list %}
                    <li>
                        <a href="{% url 'spotapp:news_detail' o.pk %}">
                            {{ o.title }}
                        </a>
                    </li>
                {% empty %}
                    <li>表示できるお知らせがありません。</li>
                {% endfor %}
            </ul>
            </div>
        </div>

        <div class="nav-right">
            {% if user.is_authenticated %}
            <div class="user-menu-wrapper">

                <div class="user-info" id="userMenuBtn">
                    <div class="user-icon">
                        {% if request.user.profile.icon %}
                            <img src="{{ request.user.profile.icon.url }}" alt="icon">
                        {% else %}
                            <img src="{% static 'img/default_icon.png' %}" alt="icon">
                        {% endif %}
                    </div>
                    <!-- 名前をアイコンの下にしたい場合はここ変更 -->
                    <div class="user-name">{{ request.user.username }} さん</div>
                </div>

                <ul class="user-menu" id="userMenu">
                    <li><a href="{% url 'spotapp:profile' %}">プロフィール</a></li>

                    <li>
                        <form action="{% url 'spotapp:logout' %}" method="post" style="margin:0;">
                            {% csrf_token %}
                            <button type="submit" class="user-menu-btn logout">ログアウト</button>

                        </form>
                    </li>
                </ul>

            </div>
            {% else %}
                <a href="{% url 'spotapp:signup' %}" class="user-btn">新規登録 / ログイン</a>
            {% endif %}
        </div>
    </nav>
    {% endblock %}




    <!-- 検索バー -->
    {% block searchbar %}
    <form action="{% url 'spotapp:spot_searchresult' %}" method="get" id="searchForm" style="text-align: center;">
        <input type="text" name="q" id="search" value="{{ keyword|default:'' }}" placeholder="検索バー（あいまい検索可能）">

        <input type="hidden" name="district" id="search_district" value="{{ selected_district|default:'' }}">
        <input type="hidden" name="category" id="search_category" value="{{ selected_category|default:'' }}">

        <button type="submit">検索</button>
    </form>


    {% endblock %}

    <!-- ★ 中央幅の基準 -->
    <div class="page-container">
        {% block body %}
        {% endblock %}
    </div>


        <!-- フッター -->
    {% block footer %}
    <footer class="footer">
        <span>E班</span>
        <a href="{% url 'spotapp:contact' %}">お問い合わせ</a>
    </footer>
    {% endblock %}

    {% block script %}
<script>
  document.addEventListener("DOMContentLoaded", function () {

    // ------------------------
    // ユーザーメニュー
    // ------------------------
    const menuBtn = document.getElementById("userMenuBtn");
    const menu = document.getElementById("userMenu");

    // user menu は存在するページだけ動かす（無いページでも他JSは動かす）
    if (menuBtn && menu) {
      menuBtn.addEventListener("click", function(e) {
        e.stopPropagation();
        menu.style.display = (menu.style.display === "flex") ? "none" : "flex";
      });

      document.addEventListener("click", function() {
        if (menu.style.display === "flex") {
          menu.style.display = "none";
        }
      });
    }

    // ------------------------
    // お気に入り（画面遷移なし / Ajax）
    // 使い方: <button type="button" class="fav-btn" data-url="...">お気に入り登録</button>
    // ------------------------
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');

    document.addEventListener("click", async function (e) {
      const btn = e.target.closest(".fav-btn");
      if (!btn) return;

      // 親の onclick（カード遷移）より先に止める
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();

      const url = btn.dataset.url;
      if (!url) return;

      btn.disabled = true;
      try {
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "X-CSRFToken": csrftoken,
            "Accept": "application/json",
          },
        });

        if (!res.ok) {
            const t = await res.text();
            console.log("favorite ajax failed:", res.status, t);
            alert(`favorite失敗: ${res.status}`);
            return;
        }


        const data = await res.json();
        btn.textContent = data.favorited ? "お気に入り済み" : "お気に入り登録";

        // お気に入り一覧ページなら解除時に行を消す
        if (data.favorited === false) {
          const item = btn.closest(".favorite-item");
          if (item) item.remove();
        }
      } catch (err) {
        console.error(err);
      } finally {
        btn.disabled = false;
      }
    }, true); // capture

    // ------------------------
    // 地区・カテゴリ選択（検索はしない）
    // ------------------------
    const districtHidden = document.getElementById("search_district");
    const categoryHidden = document.getElementById("search_category");

    const districtBtn = document.getElementById("districtBtn");
    const categoryBtn = document.getElementById("categoryBtn");

    // 地区
    document.querySelectorAll(".district-item").forEach(a => {
        a.addEventListener("click", (e) => {
        e.preventDefault();       // ← 遷移（検索）を止める
        e.stopPropagation();

        const val = a.dataset.value || "";
        const label = a.dataset.label || "地区別";

        if (districtHidden) districtHidden.value = val;
        if (districtBtn) districtBtn.textContent = `${label} ▼`;
        });
    });

    // カテゴリ
    document.querySelectorAll(".category-item").forEach(a => {
        a.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();

        const val = a.dataset.value || "";
        const label = a.dataset.label || "カテゴリ";

        if (categoryHidden) categoryHidden.value = val;
        if (categoryBtn) categoryBtn.textContent = `${label} ▼`;
        });
    });

});
</script>
{% endblock %}

    </body>
    </html>