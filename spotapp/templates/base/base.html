{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}メニューHTML{% endblock %}</title>

    <!-- 共通CSS -->
    <link href="{% static 'css/style.css' %}" rel="stylesheet">

    <!-- ページ固有CSS / JS -->
    {% block extra_css %}{% endblock %}
    {% block extra_js %}{% endblock %}
</head>

<body>

<!-- ================= ナビ ================= -->
{% block nav %}
<nav>
    <div class="nav-left">
        <a href="{% url 'spotapp:index' %}" class="btn-home">ホーム</a>
    </div>

    <div class="nav-center">

        <!-- 地区 -->
        <div class="Nav-block" id="areaMenu_btn">
            <button class="Menu_btn" type="button" id="districtBtn">
                {{ selected_district_name|default:"地区別" }} ▼
            </button>

            <ul class="menu_down" id="areaMenu_down">
                <li>
                    <a href="#" class="district-item" data-value="" data-label="地区別">地区別</a>
                </li>
                {% for district in districts %}
                <li>
                    <a href="#"
                       class="district-item"
                       data-value="{{ district.district_id }}"
                       data-label="{{ district.district_name }}">
                        {{ district.district_name }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>

        <!-- カテゴリ -->
        <div class="Nav-block" id="categoryMenu_btn">
            <button class="Menu_btn" type="button" id="categoryBtn">
                {{ selected_category_name|default:"カテゴリ" }} ▼
            </button>

            <ul class="menu_down" id="categoryMenu_down">
                <li>
                    <a href="#" class="category-item" data-value="" data-label="カテゴリ">カテゴリ</a>
                </li>
                {% for category in categories %}
                <li>
                    <a href="#"
                       class="category-item"
                       data-value="{{ category.category_id }}"
                       data-label="{{ category.category_name }}">
                        {{ category.category_name }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>

        <!-- お気に入り -->
        {% if user.is_authenticated %}
        <a href="{% url 'spotapp:favorite_list' %}" class="Menu_btn nav-fav">
            お気に入り一覧
        </a>
        {% endif %}

        <!-- お知らせ -->
        <div class="Nav-block" id="osiraseMenu_btn">
            <button class="Menu_btn">
                お知らせ ▼
                {% if osirase_new_count %}
                <span class="new-badge">{{ osirase_new_count }}</span>
                {% endif %}
            </button>

            <ul class="menu_down anywhere" id="osirase_down">
                {% for o in osirase_list %}
                <li>
                    <a href="{% url 'spotapp:news_detail' o.pk %}">
                        {{ o.title }}
                    </a>
                </li>
                {% empty %}
                <li>表示できるお知らせがありません。</li>
                {% endfor %}
            </ul>
        </div>

    </div>

    <!-- 右側 -->
    <div class="nav-right">
        {% if user.is_authenticated %}
        <div class="user-menu-wrapper">

            <div class="user-info" id="userMenuBtn">
                <div class="user-icon">
                    {% if request.user.profile.icon %}
                    <img src="{{ request.user.profile.icon.url }}" alt="icon">
                    {% else %}
                    <img src="{% static 'img/default_icon.png' %}" alt="icon">
                    {% endif %}
                </div>
            </div>

            <ul class="user-menu" id="userMenu">
                <li>
                    <a href="{% url 'spotapp:profile' %}">プロフィール</a>
                </li>
                <li>
                    <form action="{% url 'spotapp:logout' %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="user-menu-btn logout">
                            ログアウト
                        </button>
                    </form>
                </li>
            </ul>

        </div>
        {% else %}
        <a href="{% url 'spotapp:signup' %}" class="user-btn">
            <span class="pc-only">新規登録 / ログイン</span>
            <span class="sp-only">新規登録<br>ログイン</span>
        </a>
        {% endif %}
    </div>
</nav>
{% endblock %}

<!-- ================= 検索バー ================= -->
{% block searchbar %}
<form action="{% url 'spotapp:spot_searchresult' %}"
      method="get"
      id="searchForm"
      style="text-align: center;">

    <input type="text"
           name="q"
           id="search"
           value="{{ keyword|default:'' }}"
           placeholder="検索バー（あいまい検索可能）">

    <input type="hidden" name="district" id="search_district"
           value="{{ selected_district|default:'' }}">
    <input type="hidden" name="category" id="search_category"
           value="{{ selected_category|default:'' }}">

    <button type="submit" class="submit">検索</button>
</form>
{% endblock %}

<!-- ================= 本文 ================= -->
<div class="page-container">
    {% block body %}{% endblock %}
</div>

<!-- ================= フッター ================= -->
{% block footer %}
<footer class="footer">
    <span>&copy; E班</span>
    <a href="{% url 'spotapp:contact' %}">お問い合わせ</a>
</footer>
{% endblock %}

<!-- ================= JS ================= -->
{% block script %}
<script>
document.addEventListener("DOMContentLoaded", function () {

    // ユーザーメニュー
    const menuBtn = document.getElementById("userMenuBtn");
    const menu = document.getElementById("userMenu");

    if (menuBtn && menu) {
        menuBtn.addEventListener("click", function (e) {
            e.stopPropagation();
            menu.style.display = (menu.style.display === "flex") ? "none" : "flex";
        });

        document.addEventListener("click", function () {
            menu.style.display = "none";
            document.querySelectorAll(".Nav-block.open")
                .forEach(b => b.classList.remove("open"));
        });
    }

    // 地区・カテゴリ
    document.querySelectorAll(".district-item").forEach(a => {
        a.addEventListener("click", e => {
            e.preventDefault();
            document.getElementById("search_district").value = a.dataset.value || "";
            document.getElementById("districtBtn").textContent = `${a.dataset.label} ▼`;
        });
    });

    document.querySelectorAll(".category-item").forEach(a => {
        a.addEventListener("click", e => {
            e.preventDefault();
            document.getElementById("search_category").value = a.dataset.value || "";
            document.getElementById("categoryBtn").textContent = `${a.dataset.label} ▼`;
        });
    });

    // 検索条件チェック
    const searchForm = document.getElementById("searchForm");
    searchForm.addEventListener("submit", function (e) {
        const d = search_district.value;
        const c = search_category.value;
        const q = search.value.trim();

        if (!d && !c && !q) {
            e.preventDefault();
            alert("検索するには地区・カテゴリかキーワードを入力してください");
        }
    });
});
</script>

<script src="{% static 'js/main.js' %}"></script>
{% endblock %}

</body>
</html>
