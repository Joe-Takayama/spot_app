{% load static %}
<head>
    <link href="{% static 'css/spot_regist.css' %}" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <title>{% block title %} è¦³å…‰åœ°ç™»éŒ² {% endblock %}</title>
</head>

{% block body %}
<div class="home-btn">
    <a href="{% url 'spotapp_admin:index' %}">ãƒ›ãƒ¼ãƒ </a>
</div>

<div class="spot_registration-container">
  <div class="spot_registration-form">
        <h2>è¦³å…‰åœ°ç™»éŒ²</h2>

      <form class="form-box" method="POST" enctype="multipart/form-data" action="{% url 'spotapp_admin:spot_registration' %}">

        {% if spot_form.errors %}
            <div class="error">
                {{ spot_form.errors }}
            </div>
        {% endif %}

        {% if photo_form.errors %}
            <div class="error">
                {{ photo_form.errors }}
            </div>
        {% endif %}
        
      {% csrf_token %}

      {{ spot_form.spot_name }}
      {{ spot_form.address }}
        <button type="button" id="search-address" style="margin:10px 0;">
            ä½æ‰€ã‹ã‚‰åœ°å›³è¡¨ç¤º
        </button>

      {{ spot_form.business_hours }}
      {{ spot_form.explanation }}
 
    <div class="form-section">
        <p>åœ°åŒºã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        {{ spot_form.district }}
    </div>
     <!-- ğŸŒ ã“ã“ã«åœ°å›³ã‚’è¿½åŠ  -->
      <p>åœ°å›³ã§å ´æ‰€ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
      <div id="map" style="height:350px; margin-bottom:15px;"></div>

      {{ spot_form.latitude }}
      {{ spot_form.longitude }}
    <div class="form-section category-list">
        <p>ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        {{ spot_form.category }}
    </div>
      <p>å†™çœŸã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</p>
      {{ photo_form.image }}

      <button type="submit">ç™»éŒ²</button>
      </form>
  </div>
</div>

<!-- JSã¯ã“ã“ -->


<!-- Leafletæœ¬ä½“ -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const map = L.map('map').setView([35.681236, 139.767125], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    let marker = null;

    map.on('click', function(e){
        if(marker){
            marker.setLatLng(e.latlng);
        } else {
            marker = L.marker(e.latlng).addTo(map);
        }
        document.getElementById("id_latitude").value = e.latlng.lat;
        document.getElementById("id_longitude").value = e.latlng.lng;
    });

    // ä½æ‰€ãƒ»æ–½è¨­åæ¤œç´¢
    document.getElementById("search-address").addEventListener("click", function(){

        const input = document.getElementById("id_address");
        if(!input || !input.value.trim()){
            alert("ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
        }

        const address = input.value;
        const hasNumber = /\d/.test(address);

        const url = hasNumber
            ? `https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(address)}`
            : `https://nominatim.openstreetmap.org/search?format=json&limit=1&accept-language=ja&countrycodes=jp&q=${encodeURIComponent("æ—¥æœ¬ " + address)}`;
        
        fetch(url)
        .then(res => res.json())
        .then(data => {

            if(!data || data.length === 0) {
                alert("å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ä½æ‰€ã‚’è©³ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }

            let lat, lng;

            if (hasNumber) {
                // å›½åœŸåœ°ç†é™¢[lng, lat]
                lat = data[0].geometry.coordinates[1];
                lng = data[0].geometry.coordinates[0];
            } else {
                //ã‚ªãƒ¼ãƒ—ãƒ³ã‚¹ãƒˆãƒªãƒ¼ãƒ 
                lat = data[0].lat;
                lng = data[0].lon;
            }

            lat = parseFloat(lat);
            lng = parseFloat(lng);

            map.setView([lat, lng], 16);

            if(marker) {
                marker.setLatLng([lat, lng]);
            } else {
                marker = L.marker([lat, lng]).addTo(map);
            }

            document.getElementById("id_latitude").value = lat;
            document.getElementById("id_longitude").value = lng;
        })
        .catch(()=> {
            alert("æ¤œç´¢ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
        });
    });

});
</script>

{% endblock %}
